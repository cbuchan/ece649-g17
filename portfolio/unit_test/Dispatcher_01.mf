;========================================================================
; Unit Test for Dispatcher (1)
;========================================================================
;18649 Fall 2012
;Group17
;Collin Buchan (cbuchan) - Author
;Rajeev Sharma (rdsharma)
;Jesse Salazar (jessesal)
;Jessica Tiu   (jtiu)
;
;Last modified 2012-10-11 (cbuchan)
;========================================================================

; Unit test for Dispatcher
; General test, completes all transitions and states

#INCLUDE defines.mf ;include CAN id and period definitions

#DEFINE CONST_DWELL 20

;========================================================================
;initialize
;========================================================================
0s     I DOOR_CLOSED_SENSOR_PERIOD N DOOR_CLOSED_SENSOR_[FRONT][LEFT]_CAN_ID DoorClosed FRONT LEFT = true
0s     I DOOR_CLOSED_SENSOR_PERIOD N DOOR_CLOSED_SENSOR_[FRONT][RIGHT]_CAN_ID DoorClosed FRONT RIGHT = true
0s     I DOOR_CLOSED_SENSOR_PERIOD N DOOR_CLOSED_SENSOR_[BACK][LEFT]_CAN_ID DoorClosed BACK LEFT = true
0s     I DOOR_CLOSED_SENSOR_PERIOD N DOOR_CLOSED_SENSOR_[BACK][RIGHT]_CAN_ID DoorClosed BACK RIGHT = true

0s     I AT_FLOOR_PERIOD N AT_FLOOR_[1][FRONT]_CAN_ID AtFloor 1 FRONT = true

;#state 'INIT'
+0.25s  A S Dispatcher : STATE == STATE_INIT
+0s     A N DESIRED_FLOOR_CAN_ID DesiredFloor : getFloor == 1
+0s     A N DESIRED_FLOOR_CAN_ID DesiredFloor : getHallway == NONE
+0s     A N DESIRED_FLOOR_CAN_ID DesiredFloor : getDirection == STOP

+0s     A N DESIRED_DWELL_[FRONT]_CAN_ID DesiredDwell FRONT : getDwell == CONST_DWELL
+0s     A N DESIRED_DWELL_[BACK]_CAN_ID DesiredDwell BACK : getDwell == CONST_DWELL

;#transition 'T11.1'
+0.25s  I DOOR_CONTROL_PERIOD N HALL_CALL_[3][FRONT][UP]_CAN_ID Boolean = true

;#state 'COMPUTE_NEXT'
;#transition 'T11.2'
;ALWAYS TRUE

;#transition 'T11.3'
;#state 'SERVICE_CALL'
+0.25s  A S Dispatcher : STATE == STATE_SERVICE_CALL
+0s     A N DESIRED_FLOOR_CAN_ID DesiredFloor : getFloor == 2
+0s     A N DESIRED_FLOOR_CAN_ID DesiredFloor : getHallway == BACK
+0s     A N DESIRED_FLOOR_CAN_ID DesiredFloor : getDirection == STOP

+0s     A N DESIRED_DWELL_[FRONT]_CAN_ID DesiredDwell FRONT : getDwell == CONST_DWELL
+0s     A N DESIRED_DWELL_[BACK]_CAN_ID DesiredDwell BACK : getDwell == CONST_DWELL

;Elevator travels up to desired floor...
+0.25s  I AT_FLOOR_PERIOD N AT_FLOOR_[1][FRONT]_CAN_ID AtFloor 1 FRONT = false

;#transition 'T11.3'
;elevator arrives at new floor, and opens back doors
+0.25s  I AT_FLOOR_PERIOD N AT_FLOOR_[2][BACK]_CAN_ID AtFloor 2 BACK = true
+0.05s  I DOOR_CLOSED_SENSOR_PERIOD N DOOR_CLOSED_SENSOR_[BACK][LEFT]_CAN_ID DoorClosed BACK LEFT = false
+0.05s  I DOOR_CLOSED_SENSOR_PERIOD N DOOR_CLOSED_SENSOR_[BACK][RIGHT]_CAN_ID DoorClosed BACK RIGHT = false

;#state 'COMPUTE_NEXT'
;#transition 'T11.2'
;ALWAYS TRUE

;#state 'SERVICE_CALL'
+0.50s  A S Dispatcher : STATE == STATE_SERVICE_CALL
+0s     A N DESIRED_FLOOR_CAN_ID DesiredFloor : getFloor == 3
+0s     A N DESIRED_FLOOR_CAN_ID DesiredFloor : getHallway == FRONT
+0s     A N DESIRED_FLOOR_CAN_ID DesiredFloor : getDirection == STOP

;doors close again
+0.25s  I DOOR_CLOSED_SENSOR_PERIOD N DOOR_CLOSED_SENSOR_[BACK][LEFT]_CAN_ID DoorClosed BACK LEFT = true
+0.05s  I DOOR_CLOSED_SENSOR_PERIOD N DOOR_CLOSED_SENSOR_[BACK][RIGHT]_CAN_ID DoorClosed BACK RIGHT = true

;Elevator continues to operate in Sabbath mode...
+0.25s  I AT_FLOOR_PERIOD N AT_FLOOR_[2][BACK]_CAN_ID AtFloor 2 BACK = false

;#transition 'T11.3'
+0.25s  I AT_FLOOR_PERIOD N AT_FLOOR_[3][FRONT]_CAN_ID AtFloor 3 FRONT = true
+0.25s  I DOOR_CONTROL_PERIOD N HALL_CALL_[3][FRONT][UP]_CAN_ID Boolean = false

+0.25s  I DOOR_CLOSED_SENSOR_PERIOD N DOOR_CLOSED_SENSOR_[FRONT][LEFT]_CAN_ID DoorClosed FRONT LEFT = false
+0.05s  I DOOR_CLOSED_SENSOR_PERIOD N DOOR_CLOSED_SENSOR_[FRONT][RIGHT]_CAN_ID DoorClosed FRONT RIGHT = false

;Check to see that it didn't transition
;#state 'SERVICE_CALL'
+0.50s  A S Dispatcher : STATE == STATE_SERVICE_CALL
+0s     A N DESIRED_FLOOR_CAN_ID DesiredFloor : getFloor == 3
+0s     A N DESIRED_FLOOR_CAN_ID DesiredFloor : getHallway == FRONT
+0s     A N DESIRED_FLOOR_CAN_ID DesiredFloor : getDirection == STOP

;passenger enters elevator

;Doors close in preparation to leave for next floor
+0.25s  I DOOR_CLOSED_SENSOR_PERIOD N DOOR_CLOSED_SENSOR_[FRONT][LEFT]_CAN_ID DoorClosed FRONT LEFT = true
+0.05s  I DOOR_CLOSED_SENSOR_PERIOD N DOOR_CLOSED_SENSOR_[FRONT][RIGHT]_CAN_ID DoorClosed FRONT RIGHT = true

;Car leaves floor
+0.25s  I AT_FLOOR_PERIOD N AT_FLOOR_[3][FRONT]_CAN_ID AtFloor 3 FRONT = false

;#transition 'T11.4'
;door opens in middle of hallway for some reason
+0.25s  I DOOR_CLOSED_SENSOR_PERIOD N DOOR_CLOSED_SENSOR_[FRONT][LEFT]_CAN_ID DoorClosed FRONT LEFT = false

;#state 'STATE_INIT'
+0.50s  A S Dispatcher : STATE == STATE_INIT
+0s     A N DESIRED_FLOOR_CAN_ID DesiredFloor : getFloor == 1
+0s     A N DESIRED_FLOOR_CAN_ID DesiredFloor : getHallway == NONE
+0s     A N DESIRED_FLOOR_CAN_ID DesiredFloor : getDirection == STOP

;doors close and car travels to first floor
+0.25s  I DOOR_CLOSED_SENSOR_PERIOD N DOOR_CLOSED_SENSOR_[FRONT][LEFT]_CAN_ID DoorClosed FRONT LEFT = true
+0.25s  I AT_FLOOR_PERIOD N AT_FLOOR_[3][FRONT]_CAN_ID AtFloor 3 FRONT = true
+0.25s  I AT_FLOOR_PERIOD N AT_FLOOR_[3][FRONT]_CAN_ID AtFloor 3 FRONT = false
+0.25s  I AT_FLOOR_PERIOD N AT_FLOOR_[2][BACK]_CAN_ID AtFloor 2 BACK = true
+0.25s  I AT_FLOOR_PERIOD N AT_FLOOR_[2][BACK]_CAN_ID AtFloor 2 BACK = false
+0.25s  I AT_FLOOR_PERIOD N AT_FLOOR_[1][FRONT]_CAN_ID AtFloor 1 FRONT = true

;Still in STATE_INIT after reaching first floor
;#state 'STATE_INIT'
+0.50s  A S Dispatcher : STATE == STATE_INIT
+0s     A N DESIRED_FLOOR_CAN_ID DesiredFloor : getFloor == 1
+0s     A N DESIRED_FLOOR_CAN_ID DesiredFloor : getHallway == NONE
+0s     A N DESIRED_FLOOR_CAN_ID DesiredFloor : getDirection == STOP

;Passenger makes a car call
+0.25s  I CAR_BUTTON_CONTROL_PERIOD N CAR_CALL_[5][FRONT]_CAN_ID Boolean = TRUE

;#transition 'T11.1'
;#state 'SERVICE_CALL'
+0.50s  A S Dispatcher : STATE == STATE_SERVICE_CALL
+0s     A N DESIRED_FLOOR_CAN_ID DesiredFloor : getFloor == 2
+0s     A N DESIRED_FLOOR_CAN_ID DesiredFloor : getHallway == BACK
+0s     A N DESIRED_FLOOR_CAN_ID DesiredFloor : getDirection == STOP






